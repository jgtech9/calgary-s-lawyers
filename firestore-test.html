<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firestore Connection Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }
        
        .status-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .status-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .status-icon.success {
            background: #10b981;
            color: white;
        }
        
        .status-icon.error {
            background: #ef4444;
            color: white;
        }
        
        .status-content {
            color: #555;
            line-height: 1.6;
        }
        
        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 20px;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .test-button:active {
            transform: translateY(0);
        }
        
        .results {
            margin-top: 30px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding-left: 10px;
            border-left: 3px solid transparent;
        }
        
        .log-entry.success {
            border-left-color: #10b981;
            color: #065f46;
        }
        
        .log-entry.error {
            border-left-color: #ef4444;
            color: #991b1b;
        }
        
        .log-entry.info {
            border-left-color: #3b82f6;
            color: #1e40af;
        }
        
        .instructions {
            background: #f0f9ff;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            border: 2px dashed #3b82f6;
        }
        
        .instructions h3 {
            color: #1e40af;
            margin-bottom: 10px;
        }
        
        .instructions ol {
            margin-left: 20px;
            color: #374151;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        code {
            background: #e5e7eb;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• Firestore Connection Test</h1>
        <p class="subtitle">Calgary Lawyer Directory - Firebase Integration</p>
        
        <div class="status-card">
            <div class="status-title">
                <div class="status-icon" id="connection-status">?</div>
                <span>Connection Status</span>
            </div>
            <div class="status-content" id="status-details">
                Click "Test Connection" to check Firestore access
            </div>
        </div>
        
        <button class="test-button" onclick="runTest()">
            üîç Test Firestore Connection
        </button>
        
        <div class="results" id="test-results">
            <!-- Test results will appear here -->
        </div>
        
        <div class="instructions">
            <h3>üìã Deployment Instructions</h3>
            <ol>
                <li>Ensure Firebase CLI is installed: <code>npm install -g firebase-tools</code></li>
                <li>Login to Firebase: <code>firebase login --no-localhost</code></li>
                <li>Deploy Firestore rules: <code>firebase deploy --only firestore:rules</code></li>
                <li>Refresh this page and test connection</li>
            </ol>
            <p><strong>Current Rules:</strong> Development mode (open access)</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            addDoc,
            deleteDoc,
            doc 
        } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: 'AIzaSyA_GhG7Cy-pjaXPaNhSxcDSeZzfs0TBVi4',
            authDomain: 'calgary-lawyer-directory-d4c44.firebaseapp.com',
            projectId: 'calgary-lawyer-directory-d4c44',
            storageBucket: 'calgary-lawyer-directory-d4c44.firebasestorage.app',
            messagingSenderId: '27772805268',
            appId: '1:27772805268:web:b04ab5d3fcfa69444f1481',
            measurementId: 'G-B3LNM8D1QQ'
        };

        const resultsDiv = document.getElementById('test-results');
        const statusIcon = document.getElementById('connection-status');
        const statusDetails = document.getElementById('status-details');

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = message;
            resultsDiv.appendChild(entry);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        async function runTest() {
            // Clear previous results
            resultsDiv.innerHTML = '';
            statusIcon.textContent = '‚è≥';
            statusIcon.className = 'status-icon';
            statusDetails.textContent = 'Testing connection...';

            log('üöÄ Starting Firestore Connection Test', 'info');
            log('=====================================', 'info');

            try {
                // Initialize Firebase
                log('1. Initializing Firebase...', 'info');
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                log(`‚úÖ Firebase initialized - Project: ${app.options.projectId}`, 'success');

                // Test Read Access
                log('\n2. Testing READ access to lawyers collection...', 'info');
                const lawyersRef = collection(db, 'lawyers');
                const lawyersSnapshot = await getDocs(lawyersRef);
                log(`‚úÖ Read access granted - Found ${lawyersSnapshot.size} lawyers`, 'success');

                // Display sample data
                if (lawyersSnapshot.size > 0) {
                    log('   Sample lawyers:', 'info');
                    lawyersSnapshot.forEach((doc, index) => {
                        if (index < 3) {
                            const data = doc.data();
                            log(`   ‚Ä¢ ${doc.id}: ${data.profile_data?.name || 'Unnamed'}`, 'info');
                        }
                    });
                } else {
                    log('   ‚ÑπÔ∏è Collection is empty - normal for new projects', 'info');
                }

                // Test Write Access
                log('\n3. Testing WRITE access...', 'info');
                const testCollection = collection(db, '_test_connection');
                const testDoc = {
                    test: 'Firestore connection test',
                    timestamp: new Date().toISOString(),
                    project: 'Calgary Lawyer Directory'
                };

                const docRef = await addDoc(testCollection, testDoc);
                log(`‚úÖ Write access granted - Created test document: ${docRef.id}`, 'success');

                // Clean up test document
                log('4. Cleaning up test document...', 'info');
                await deleteDoc(doc(db, '_test_connection', docRef.id));
                log('‚úÖ Test document cleaned up', 'success');

                // Test Other Collections
                log('\n5. Testing other collections...', 'info');
                const collections = ['users', 'intake_leads', 'messages', 'appointments'];
                
                for (const colName of collections) {
                    try {
                        const colRef = collection(db, colName);
                        const snapshot = await getDocs(colRef);
                        log(`   ${colName}: ${snapshot.size} documents`, 'info');
                    } catch (error) {
                        log(`   ${colName}: ${error.code === 'permission-denied' ? 'Access denied' : 'Not found'}`, 'info');
                    }
                }

                // Update status
                statusIcon.textContent = '‚úÖ';
                statusIcon.className = 'status-icon success';
                statusDetails.innerHTML = `
                    <strong>Connection Successful!</strong><br>
                    ‚Ä¢ Project: ${app.options.projectId}<br>
                    ‚Ä¢ Read/Write: Enabled<br>
                    ‚Ä¢ Lawyers: ${lawyersSnapshot.size} documents
                `;

                log('\nüéâ TEST COMPLETE - All checks passed!', 'success');
                log('Your Firestore is ready for development.', 'success');

            } catch (error) {
                log(`‚ùå TEST FAILED: ${error.message}`, 'error');
                log(`Error code: ${error.code}`, 'error');
                
                statusIcon.textContent = '‚ùå';
                statusIcon.className = 'status-icon error';
                statusDetails.innerHTML = `
                    <strong>Connection Failed</strong><br>
                    ‚Ä¢ Error: ${error.code}<br>
                    ‚Ä¢ Message: ${error.message}<br>
                    ‚Ä¢ Check Firestore rules deployment
                `;

                log('\nüîß TROUBLESHOOTING:', 'info');
                log('1. Ensure Firestore rules are deployed', 'info');
                log('2. Check if rules allow public access', 'info');
                log('3. Verify project ID matches', 'info');
            }
        }

        // Make function available globally
        window.runTest = runTest;

        // Auto-test on page load (optional)
        // setTimeout(runTest, 1000);
    </script>
</body>
</html>
